---
title: "Indicadores longitudinales"
author: "Equipo OCS"
date: "20-06-2023"
output:
  html_document:
    number_sections: true
    toc: true
    toc_float: true
---

# Indicadores longitudinales

Este documento genera los distintos indicadores que serán utilizados para medir los cambios en la cohesión social en chile en los años 2016-2022. Para esto se utilizan los datos de las seis olas disponibles de ELSOC.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=F, message=F)
```

```{r include=FALSE}
# Cargar paquetes
pacman::p_load(dplyr, panelr, survey, ggplot2, summarytools, shadowtext, semTools, psych, semPlot)
```

```{r include=FALSE}
# Cargar base elsoc longitudinal (2016-2019) creada en "preparacion"
load("input/data/proc/data.RData")

data$c02_rec_w01 <- as.numeric(data$c02_rec_w01)
data$c03_rec_w01 <- as.numeric(data$c03_rec_w01)
data$c04_rec_w01 <- as.numeric(data$c04_rec_w01)

data$c02_rec_w02 <- as.numeric(data$c02_rec_w02)
data$c03_rec_w02 <- as.numeric(data$c03_rec_w02)
data$c04_rec_w02 <- as.numeric(data$c04_rec_w02)

data$c02_rec_w03 <- as.numeric(data$c02_rec_w03)
data$c03_rec_w03 <- as.numeric(data$c03_rec_w03)
data$c04_rec_w03 <- as.numeric(data$c04_rec_w03)

data$c02_rec_w04 <- as.numeric(data$c02_rec_w04)
data$c03_rec_w04 <- as.numeric(data$c03_rec_w04)
data$c04_rec_w04 <- as.numeric(data$c04_rec_w04)

data$c02_rec_w05 <- as.numeric(data$c02_rec_w05)
data$c03_rec_w05 <- as.numeric(data$c03_rec_w05)
data$c04_rec_w05 <- as.numeric(data$c04_rec_w05)

data$c02_rec_w06 <- as.numeric(data$c02_rec_w06)
data$c03_rec_w06 <- as.numeric(data$c03_rec_w06)
data$c04_rec_w06 <- as.numeric(data$c04_rec_w06)
```

# Horizontal

## w01

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_horizontal_w01 <- '
pertenencia =~ c32_01_w01 + c32_02_w01
barrial =~ t02_01_w01 + t02_02_w01 + t02_03_w01 + t02_04_w01
redes  =~ c02_rec_w01 + c03_rec_w01 + c04_rec_w01 + c07_02_w01 + c07_03_w01
'
fit_horizontal_w01 <- cfa(cfa_horizontal_w01, data=data)

fitmeasures(fit_horizontal_w01,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_horizontal_w01, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## w02

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_horizontal_w02 <- '
pertenencia =~ c32_01_w02 + c32_02_w02
barrial =~ t02_01_w02 + t02_02_w02 + t02_03_w02 + t02_04_w02
redes  =~ c02_rec_w02 + c03_rec_w02 + c04_rec_w02 + c07_02_w02 + c07_03_w02
'
fit_horizontal_w02 <- cfa(cfa_horizontal_w02, data=data)

fitmeasures(fit_horizontal_w02,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_horizontal_w02, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## w03

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_horizontal_w03 <- '
pertenencia =~ c32_01_w03 + c32_02_w03
barrial =~ t02_01_w03 + t02_02_w03 + t02_03_w03 + t02_04_w03
redes  =~ c02_rec_w03 + c03_rec_w03 + c04_rec_w03 + c07_02_w03 + c07_03_w03
'
fit_horizontal_w03 <- cfa(cfa_horizontal_w03, data=data)

fitmeasures(fit_horizontal_w03,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_horizontal_w03, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## w04

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_horizontal_w04 <- '
pertenencia =~ c32_01_w04 + c32_02_w04
barrial =~ t02_01_w04 + t02_02_w04 + t02_03_w04 + t02_04_w04
redes  =~ c02_rec_w04 + c03_rec_w04 + c04_rec_w04 + c07_02_w04 + c07_03_w04
'
fit_horizontal_w04 <- cfa(cfa_horizontal_w04, data=data)

fitmeasures(fit_horizontal_w04,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_horizontal_w04, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## w05

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_horizontal_w05 <- '
pertenencia =~ c32_01_w05 + c32_02_w05
redes  =~ c02_rec_w05 + c03_rec_w05 + c04_rec_w05 + c07_02_w05 + c07_03_w05
'
fit_horizontal_w05 <- cfa(cfa_horizontal_w05, data=data)

fitmeasures(fit_horizontal_w05,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_horizontal_w05, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## w06

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_horizontal_w06 <- '
pertenencia =~ c32_01_w06 + c32_02_w06
barrial =~ t02_01_w06 + t02_02_w06 + t02_03_w06 + t02_04_w06
'
fit_horizontal_w06 <- cfa(cfa_horizontal_w06, data=data)

fitmeasures(fit_horizontal_w06,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_horizontal_w06, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## Puntuaciones factoriales

```{r}
pw01 <- predict(fit_horizontal_w01)
pw02 <- predict(fit_horizontal_w02)
pw03 <- predict(fit_horizontal_w03)
pw04 <- predict(fit_horizontal_w04)
pw05 <- predict(fit_horizontal_w05)
pw06 <- predict(fit_horizontal_w06)

scores_horizontal_w01 = as.data.frame(pw01) %>% 
  cbind(anio=c("2016"))
scores_horizontal_w02 = as.data.frame(pw02)%>% 
  cbind(anio=c("2017"))
scores_horizontal_w03 = as.data.frame(pw03)%>% 
  cbind(anio=c("2018"))
scores_horizontal_w04 = as.data.frame(pw04)%>% 
  cbind(anio=c("2019"))
scores_horizontal_w05 = as.data.frame(pw05)%>% 
  cbind(anio=c("2021"),
        barrial=c(NA))
scores_horizontal_w06 = as.data.frame(pw06)%>% 
  cbind(anio=c("2022"),
        redes=c(NA))

scores_horizontal_w01$pertenencia <- scales::rescale(scores_horizontal_w01$pertenencia, to=c(1, 5))
scores_horizontal_w01$barrial <- scales::rescale(scores_horizontal_w01$barrial , to=c(1, 5))
scores_horizontal_w01$redes <- scales::rescale(scores_horizontal_w01$redes , to=c(1, 5))

scores_horizontal_w02$pertenencia <- scales::rescale(scores_horizontal_w02$pertenencia, to=c(1, 5))
scores_horizontal_w02$barrial <- scales::rescale(scores_horizontal_w02$barrial , to=c(1, 5))
scores_horizontal_w02$redes <- scales::rescale(scores_horizontal_w02$redes , to=c(1, 5))

scores_horizontal_w03$pertenencia <- scales::rescale(scores_horizontal_w03$pertenencia, to=c(1, 5))
scores_horizontal_w03$barrial <- scales::rescale(scores_horizontal_w03$barrial , to=c(1, 5))
scores_horizontal_w03$redes <- scales::rescale(scores_horizontal_w03$redes , to=c(1, 5))

scores_horizontal_w04$pertenencia <- scales::rescale(scores_horizontal_w04$pertenencia, to=c(1, 5))
scores_horizontal_w04$barrial <- scales::rescale(scores_horizontal_w04$barrial , to=c(1, 5))
scores_horizontal_w04$redes <- scales::rescale(scores_horizontal_w04$redes , to=c(1, 5))

scores_horizontal_w05$pertenencia <- scales::rescale(scores_horizontal_w05$pertenencia, to=c(1, 5))
scores_horizontal_w05$redes <- scales::rescale(scores_horizontal_w05$redes , to=c(1, 5))

scores_horizontal_w06$pertenencia <- scales::rescale(scores_horizontal_w06$pertenencia, to=c(1, 5))
scores_horizontal_w06$barrial <- scales::rescale(scores_horizontal_w06$barrial , to=c(1, 5))

# Merge with factor scores
scores_horizontal <- rbind(scores_horizontal_w01, scores_horizontal_w02, scores_horizontal_w03, scores_horizontal_w04, scores_horizontal_w05, scores_horizontal_w06)

horizontal_anio <- scores_horizontal %>% group_by(anio) %>% 
  summarise(pertenencia=mean(pertenencia, na.rm=TRUE),
            apego=mean(barrial, na.rm=TRUE),
            redes=mean(redes, na.rm=TRUE))
```

# Vertical

## w01

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_vertical_w01 <- '
instituciones =~ c05_01_w01 + c05_02_w01 + c05_05_w01 + c05_07_w01
participacion =~ c08_04_w01 + c13_w01 + c14_01_w01 + c14_02_w01
meritocracia =~ c18_09_w01 + c18_10_w01
'
fit_vertical_w01 <- cfa(cfa_vertical_w01 , data=data)

fitmeasures(fit_vertical_w01,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_vertical_w01, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## w02

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_vertical_w02 <- '
instituciones =~ c05_01_w02 + c05_02_w02 + c05_05_w02 + c05_07_w02
participacion =~ c08_04_w02 + c13_w02 + c14_01_w02 + c14_02_w02
meritocracia =~ c18_09_w02 + c18_10_w02
'
fit_vertical_w02 <- cfa(cfa_vertical_w02 , data=data)

fitmeasures(fit_vertical_w02,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_vertical_w02, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## w03

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_vertical_w03 <- '
instituciones =~ c05_01_w03 + c05_02_w03 + c05_05_w03 + c05_07_w03
participacion =~ c08_04_w03 + c13_w03 + c14_01_w03 + c14_02_w03
meritocracia =~ c18_09_w03 + c18_10_w03
'
fit_vertical_w03 <- cfa(cfa_vertical_w03 , data=data)

fitmeasures(fit_vertical_w03,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_vertical_w03, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## w04

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_vertical_w04 <- '
instituciones =~ c05_01_w04 + c05_02_w04 + c05_05_w04 + c05_07_w04
participacion =~ c08_04_w04 + c13_w04 + c14_01_w04 + c14_02_w04
meritocracia =~ c18_09_w04 + c18_10_w04
'
fit_vertical_w04 <- cfa(cfa_vertical_w04 , data=data)

fitmeasures(fit_vertical_w04,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_vertical_w04, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## w05

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_vertical_w05 <- '
instituciones =~ c05_01_w05 + c05_02_w05 + c05_05_w05 + c05_07_w05
participacion =~ c08_04_w05 + c13_w05 + c14_01_w05 + c14_02_w05
meritocracia =~ c18_09_w05 + c18_10_w05
'
fit_vertical_w05 <- cfa(cfa_vertical_w05 , data=data)

fitmeasures(fit_vertical_w05,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_vertical_w05, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## w06

* Análisis factorial confirmatorio
```{r}
# probar tres dimensiones
cfa_vertical_w06 <- '
instituciones =~ c05_01_w06 + c05_02_w06 + c05_05_w06 + c05_07_w06
participacion =~ c08_04_w06 + c13_w06 + c14_01_w06 + c14_02_w06
meritocracia =~ c18_09_w06 + c18_10_w06
'
fit_vertical_w06 <- cfa(cfa_vertical_w06 , data=data)

fitmeasures(fit_vertical_w06,
            fit.measures = c("chisq", "df", "pvalue", 
                             "cfi", "rmsea"))

semPaths(fit_vertical_w06, # modelo ajustado
         what = "std",  # mostrar cargas estandarizadas
         label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
         residuals = FALSE, # no mostrar residuos
         edge.color = "black", # color flechas
         nCharNodes = 0,
         label.prop=0)
```

## Puntuaciones factoriales

```{r}
pvw01 <- predict(fit_vertical_w01)
pvw02 <- predict(fit_vertical_w02)
pvw03 <- predict(fit_vertical_w03)
pvw04 <- predict(fit_vertical_w04)
pvw05 <- predict(fit_vertical_w05)
pvw06 <- predict(fit_vertical_w06)

scores_vertical_w01 = as.data.frame(pvw01)%>% 
  cbind(anio=c("2016"))
scores_vertical_w02 = as.data.frame(pvw02)%>% 
  cbind(anio=c("2017"))
scores_vertical_w03 = as.data.frame(pvw03)%>% 
  cbind(anio=c("2018"))
scores_vertical_w04 = as.data.frame(pvw04)%>% 
  cbind(anio=c("2019"))
scores_vertical_w05 = as.data.frame(pvw05)%>% 
  cbind(anio=c("2021"))
scores_vertical_w05 <- scores_vertical_w05 %>% filter(instituciones>0 | participacion>0)
scores_vertical_w06 = as.data.frame(pvw06)%>% 
  cbind(anio=c("2022"))

scores_vertical_w01$instituciones <- scales::rescale(scores_vertical_w01$instituciones, to=c(1, 5))
scores_vertical_w01$participacion <- scales::rescale(scores_vertical_w01$participacion, to=c(1, 5))
scores_vertical_w01$meritocracia <- scales::rescale(scores_vertical_w01$meritocracia, to=c(1, 5))

scores_vertical_w02$instituciones <- scales::rescale(scores_vertical_w02$instituciones, to=c(1, 5))
scores_vertical_w02$participacion <- scales::rescale(scores_vertical_w02$participacion, to=c(1, 5))
scores_vertical_w02$meritocracia <- scales::rescale(scores_vertical_w02$meritocracia, to=c(1, 5))

scores_vertical_w03$instituciones <- scales::rescale(scores_vertical_w03$instituciones, to=c(1, 5))
scores_vertical_w03$participacion <- scales::rescale(scores_vertical_w03$participacion, to=c(1, 5))
scores_vertical_w03$meritocracia <- scales::rescale(scores_vertical_w03$meritocracia, to=c(1, 5))

scores_vertical_w04$instituciones <- scales::rescale(scores_vertical_w04$instituciones, to=c(1, 5))
scores_vertical_w04$participacion <- scales::rescale(scores_vertical_w04$participacion, to=c(1, 5))
scores_vertical_w04$meritocracia <- scales::rescale(scores_vertical_w04$meritocracia, to=c(1, 5))

scores_vertical_w05$instituciones <- scales::rescale(scores_vertical_w05$instituciones, to=c(1, 5))
scores_vertical_w05$participacion <- scales::rescale(scores_vertical_w05$participacion, to=c(1, 5))
scores_vertical_w05$meritocracia <- scales::rescale(scores_vertical_w05$meritocracia, to=c(1, 5))

scores_vertical_w06$instituciones <- scales::rescale(scores_vertical_w06$instituciones, to=c(1, 5))
scores_vertical_w06$participacion <- scales::rescale(scores_vertical_w06$participacion, to=c(1, 5))
scores_vertical_w06$meritocracia <- scales::rescale(scores_vertical_w06$meritocracia, to=c(1, 5))

# Merge with factor scores
scores_vertical <- rbind(scores_vertical_w01, scores_vertical_w02, scores_vertical_w03, scores_vertical_w04, scores_vertical_w05, scores_vertical_w06)

vertical_anio <- scores_vertical %>% group_by(anio) %>% 
  summarise(instituciones=mean(instituciones, na.rm=TRUE),
            participacion=mean(participacion, na.rm=TRUE),
            meritocracia=mean(meritocracia, na.rm=TRUE))
```

# Graficar

## Horizontal

```{r}
horizontal_anio_long <- horizontal_anio %>% tidyr::pivot_longer(cols=c("pertenencia", "apego", "redes"),
                                                    names_to="tipo",
                                                    values_to="values")
horizontal_anio_long$values <- ifelse(horizontal_anio_long$values=="NaN", NA, horizontal_anio_long$values)

plot_horizontal <- ggplot(data = horizontal_anio_long, aes(x=anio, y=values, group=tipo, shape=tipo)) +
  geom_line(aes(color=tipo)) + 
  geom_point(aes(colour=tipo),size = 3)+
  theme_bw() + 
  xlab("Year") +
  ylab("Mean") + 
  guides(color=guide_legend(title="Horizontal"),
         shape=guide_legend(title="Horizontal"))+
  scale_y_continuous(breaks = seq(1, 5, by = 1), limits = c(1,5))

plot_horizontal
ggsave(plot_horizontal, file="output/graphs/plot_horizontal.png")
```

## Vertical

```{r}
vertical_anio_long <- vertical_anio %>% tidyr::pivot_longer(cols=c("instituciones", "participacion", "meritocracia"),
                                                    names_to="tipo",
                                                    values_to="values")

plot_vertical <- ggplot(data = vertical_anio_long, aes(x=anio, y=values, group=tipo, shape=tipo)) +
  geom_line(aes(color=tipo)) + 
  geom_point(aes(colour=tipo),size = 3)+
  theme_bw() + 
  xlab("Year") +
  ylab("Mean") + 
  guides(color=guide_legend(title="Vertical"),
         shape=guide_legend(title="Vertical"))+
  scale_y_continuous(breaks = seq(1, 5, by = 1), limits = c(1,5))

plot_vertical

ggsave(plot_vertical, file="output/graphs/plot_vertical.png")
```
